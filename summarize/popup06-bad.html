<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      min-width: 300px;
      min-height: 150px;
      padding: 10px;
      font-family: sans-serif;
    }
    #mySummaryArea {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ccc;
      resize: both;
      overflow: auto;
      max-height: 400px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      cursor: pointer;
      width: 100%;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

  <h2>Page Summarizer</h2>
  <button id="myFullPageButton">Summarize Full Page</button>
  <button id="mySelectionButton">Summarize Selected Text</button>
  
  <div id="mySummaryArea">
    Click a button to analyze the content.
  </div>

  <script>
    let myTimerInterval;
    let mySeconds = 0;

    function myStartTimer(myArea) {
      mySeconds = 0;
      myArea.textContent = 'Thinking (0s)...';
      myTimerInterval = setInterval(() => {
        mySeconds++;
        myArea.textContent = `Thinking (${mySeconds}s)...`;
      }, 1000);
    }

    function myStopTimer() {
      clearInterval(myTimerInterval);
    }

    // Grabs and summarizes the text from the entire webpage.
    async function mySummarizePage() {
      const mySummaryArea = document.getElementById('mySummaryArea');
      myStartTimer(mySummaryArea);

      const [myTab] = await chrome.tabs.query({ active: true, currentWindow: true });
      
      // Check for a valid URL
      if (myTab.url.startsWith('chrome://') || myTab.url.startsWith('chrome-extension://') || myTab.url.startsWith('file://')) {
        myStopTimer();
        mySummaryArea.textContent = 'Error: Cannot summarize this page due to security restrictions.';
        return; // Exit the function
      }

      const myResults = await chrome.scripting.executeScript({
        target: { tabId: myTab.id },
        func: myGetPageText
      });

      const myPageText = myResults[0].result;

      if (myPageText) {
        const mySummary = await mySummarizeWithPrompt(myPageText);
        myStopTimer();
        mySummaryArea.textContent = mySummary;
      } else {
        myStopTimer();
        mySummaryArea.textContent = 'Could not retrieve text from the page.';
      }
    }

    // Grabs and summarizes only the text the user has highlighted.
    async function mySummarizeSelection() {
      const mySummaryArea = document.getElementById('mySummaryArea');
      myStartTimer(mySummaryArea);

      const [myTab] = await chrome.tabs.query({ active: true, currentWindow: true });
      
      // Check for a valid URL
      if (myTab.url.startsWith('chrome://') || myTab.url.startsWith('chrome-extension://') || myTab.url.startsWith('file://')) {
        myStopTimer();
        mySummaryArea.textContent = 'Error: Cannot summarize this page due to security restrictions.';
        return; // Exit the function
      }

      const myResults = await chrome.scripting.executeScript({
        target: { tabId: myTab.id },
        func: myGetSelectedText
      });

      const mySelectedText = myResults[0].result;

      if (mySelectedText) {
        const mySummary = await mySummarizeWithPrompt(mySelectedText);
        myStopTimer();
        mySummaryArea.textContent = mySummary;
      } else {
        myStopTimer();
        mySummaryArea.textContent = 'No text was selected on the page.';
      }
    }

    // This function is injected to get all text from the page body.
    function myGetPageText() {
      return document.body.innerText;
    }

    // This function is injected to get only the selected text.
    function myGetSelectedText() {
      return window.getSelection().toString();
    }

    // This is the function that uses the LanguageModel API with a prompt.
    async function mySummarizeWithPrompt(myText) {
      if ('LanguageModel' in window) {
        try {
          const myModel = await LanguageModel.create();
          const myPrompt = `Summarize the following text:\n\n${myText}`;
          const mySummary = await myModel.prompt(myPrompt);
          return mySummary;
        } catch (error) {
          console.error('Error using LanguageModel API:', error);
          return `Error: ${error.message}`;
        }
      } else {
        return 'The LanguageModel API is not supported in this browser or is not enabled.';
      }
    }

    // Event listeners to handle button clicks.
    document.addEventListener('DOMContentLoaded', () => {
      const myFullPageButton = document.getElementById('myFullPageButton');
      const mySelectionButton = document.getElementById('mySelectionButton');

      if (myFullPageButton) {
        myFullPageButton.addEventListener('click', mySummarizePage);
      }
      if (mySelectionButton) {
        mySelectionButton.addEventListener('click', mySummarizeSelection);
      }
    });
  </script>

</body>
</html>
